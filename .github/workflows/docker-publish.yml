name: Build and Publish Docker Image

# Workflow behavior:
# - Push to main/master: Build and test only (no Docker Hub push)
# - Version tags (v*.*.*): Build, test, and push to Docker Hub (multi-arch)
# - Pull requests: Build and test only (no Docker Hub push)

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*.*.*"
  pull_request:
    branches:
      - main
      - master

env:
  IMAGE_NAME: sammccord/valkey-automerge

jobs:
  build-and-test:
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        include:
          # Base images (valkey-automerge only) - use standard runner
          - variant: debian
            dockerfile: Dockerfile
            suffix: ""
            runner: ubuntu-latest
          - variant: alpine
            dockerfile: Dockerfile.alpine
            suffix: "-alpine"
            runner: ubuntu-latest
          # Full images (valkey-automerge + valkey-json + valkey-search) - use larger runner
          - variant: full
            dockerfile: Dockerfile.full
            suffix: "-full"
            runner: ubuntu-20.04-16core
          - variant: full-alpine
            dockerfile: Dockerfile.full-alpine
            suffix: "-full-alpine"
            runner: ubuntu-20.04-16core

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          flavor: |
            suffix=${{ matrix.suffix }}
          tags: |
            # For version tags (v1.2.3), generate multiple tags
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # Tag latest for version releases
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}

      # Build single-arch for testing (load doesn't support multi-platform)
      - name: Build Docker image for testing
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          load: true
          tags: ${{ env.IMAGE_NAME }}:test-${{ matrix.variant }}
          cache-from: type=gha,scope=${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=${{ matrix.variant }}

      # Only run integration tests on Debian variant (tests use valkey-cli from debian image)
      - name: Run integration tests
        if: matrix.variant == 'debian'
        run: |
          docker compose run --rm test
          docker compose down

      # Build and push multi-arch on version tags
      - name: Build and push multi-arch Docker image
        if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=${{ matrix.variant }}

      - name: Display pushed tags
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "Successfully pushed the following tags for ${{ matrix.variant }}:"
          echo "${{ steps.meta.outputs.tags }}"

  # Create release after all variants are built
  release:
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Docker Images

            This release is available on Docker Hub with multi-architecture support (amd64, arm64):

            ### Debian-based (default)
            ```bash
            docker pull sammccord/valkey-automerge:${{ steps.version.outputs.version }}
            docker pull sammccord/valkey-automerge:latest
            ```

            ### Alpine-based (smaller image)
            ```bash
            docker pull sammccord/valkey-automerge:${{ steps.version.outputs.version }}-alpine
            docker pull sammccord/valkey-automerge:latest-alpine
            ```

            ### Full Images (with valkey-json)

            These images include both valkey-automerge and valkey-json modules for complete JSON indexing support:

            ```bash
            # Debian-based with valkey-json
            docker pull sammccord/valkey-automerge:${{ steps.version.outputs.version }}-full
            docker pull sammccord/valkey-automerge:latest-full

            # Alpine-based with valkey-json
            docker pull sammccord/valkey-automerge:${{ steps.version.outputs.version }}-full-alpine
            docker pull sammccord/valkey-automerge:latest-full-alpine
            ```

            ### Supported Architectures
            - `linux/amd64` (x86_64)
            - `linux/arm64` (aarch64, Apple Silicon, AWS Graviton)

            ### Quick Start

            ```bash
            # Run Valkey with the module
            docker run -d -p 6379:6379 sammccord/valkey-automerge:${{ steps.version.outputs.version }}

            # Or use the full image with valkey-json support
            docker run -d -p 6379:6379 sammccord/valkey-automerge:${{ steps.version.outputs.version }}-full

            # Test it works
            valkey-cli AM.NEW mydoc
            valkey-cli AM.PUTTEXT mydoc greeting "Hello, Automerge!"
            valkey-cli AM.GETTEXT mydoc greeting
            ```

            ### Full Documentation

            See the [README](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md) for complete documentation.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
